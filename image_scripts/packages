export VER_WEAVE="85b4a05c9a0fc9538ab3298e5bf0cf0630b93033"
RPO_WEAVE="https://github.com/weaveworks/weave.git"
DIR_WEAVE="weave-$VER_WEAVE"
SRC_WEAVE="$DIR_WEAVE.tar.gz"
GET_WEAVE() {
  export GOPATH="$PWD/$DIR_WEAVE"
  d="$GOPATH/src/github.com/weaveworks"
  mkdir -p "$d"
  cd "$d"
  git clone "$RPO_WEAVE"
  cd weave
  git checkout "$VER_WEAVE"
  for x in weaver weavedns sigproxy weaveproxy weavewait netcheck; do
    go get -d -tags netgo ./prog/$x
  done
  cat >> Makefile << 'EOF'
get_weave_deps: $(DOCKER_DISTRIB)
EOF
  make get_weave_deps 1>&2
  docker pull gliderlabs/alpine:latest 1>&2
  docker save -o alpine.tar gliderlabs/alpine:latest 1>&2
  tar -C "$GOPATH/.." -zc "$DIR_WEAVE"
}
BLD_WEAVE() {
  d="$GOPATH/src/github.com/weaveworks/weave"
  rm -rf "$d"
  cp -af * "$GOPATH"
  cd "$d"
  patch -p0 << 'EOF'
--- Makefile.orig
+++ Makefile
@@ -7,7 +7,7 @@
 SUDO=sudo
 
 DOCKERHUB_USER=weaveworks
-WEAVE_VERSION=git-$(shell git rev-parse --short=12 HEAD)
+WEAVE_VERSION=$(VER_WEAVE)

 WEAVER_EXE=prog/weaver/weaver
 WEAVEDNS_EXE=prog/weavedns/weavedns
EOF
  go clean -i net
  go install -tags netgo std
  # We can't make the docker images themselves until we have docker running
  CGO_CPPFLAGS="$CPPFLAGS" CGO_LDFLAGS="$LDFLAGS" make SUDO= \
      prog/weaver/weaver prog/weavedns/weavedns prog/weaveproxy/weaveproxy \
      prog/sigproxy/sigproxy prog/weavewait/weavewait prog/netcheck/netcheck
  ln -sf "$d/weave" "$GOPATH/bin"
}

PACKAGES=("${PACKAGES[@]}"
          WEAVE)
